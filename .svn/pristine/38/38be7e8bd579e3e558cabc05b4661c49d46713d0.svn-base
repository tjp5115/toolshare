/*
jquery selector stuff -- this is the magic
*/
window.onunload = refreshParent;
    function refreshParent() {
        window.opener.location.reload();
    }

$(document).ready(function(){
	$('#tableToolList').tablesorter();
	$(".updateTool").on("click", updateDivForm);
	$("#addTool").on("click", updateDivForm);
	$(".borrowTool").on("click", updateDivForm);
    $('.request').on('click',fancyLoadDiv);
    $('.displayTool').on('click',fancyLoadDiv);
	$('#updateUser').on('click', updateDivForm);

    $('.toolDesc').text(function() {
        if ($(this).text().length > 40 ){
            return $(this).text().substring(0, 30) + "...";
        }
        return $(this).text().substring(0, 30); 
    });

});
/*
dynamically fills the div addTool with an ajax call to its coresponding view
    basically magic
*/
function fancyLoadDiv() {
    var url = $(this).attr('href');
    //alert(url);
    jQuery("#fancyUpdateContent").load(
        url,
        function(){
            //alert('made it to inner function');
            var updateData = $('#fancyUpdateContent').html();
            $.fancybox(updateData);
        }
    );
    return false;
}
/*
dynamically fills the div addTool with an ajax call to its coresponding view
    basically magic
*/
function updateDivForm(days) {
    days = "hi mom";
    allDays = days;
    //alert("hi mom" + allDays)
    var url = $(this).attr('href');
    //alert(url);
    jQuery("#fancyUpdateContent").load(
        url,
        function(){
            //alert('made it to inner function');
            var updateData = $('#fancyUpdateContent').html();
            $.fancybox(updateData,
            {
                openEffect  : 'none',
                closeEffect : 'none',
                afterClose  :  function() {
                                window.location.reload();
                            } 
            });

            $(".timeStart").datepicker('destroy');
            $('.timeStart').removeClass("hasDatepicker").removeAttr('id');  
            $(".timeStart").datepicker({
                beforeShowDay: renderCalendarCallback
            });

            $(".timeEnd").datepicker('destroy');
            $('.timeEnd').removeClass("hasDatepicker").removeAttr('id');  
            $(".timeEnd").datepicker({
                beforeShowDay: renderCalendarCallback
            });
            prepareUpdateForm();
        }
    );

    return false;
}

/* this is the calendar to pull days from */
var allDays;

/*
Is called before a date is rendered. If the date is reserved, returns an
array of [false, ''], otherwise, [true, '']
*/
function renderCalendarCallback(date) {
    //alert(allDays);
    return [true, ''];
}

/*
dynamically fills the form with the form data from its coresponding view
    if valid submits 
    otherwise displays error messages
this javascript has to be in the document from my understanding. It will not load otherwise.
*/
function prepareUpdateForm(){
    $('.fancybox-inner #sendbutton').on("click",function(){
        var form = jQuery(".fancybox-inner #fancyForm");
        form.submit(function (e) {
            //jQuery("#sendwrapper").prepend('<span>Sending message, please wait... </span>')
            jQuery(".fancybox-inner #registration").load(
                form.prop('action'),
                form.serializeArray(),
                function(){
                    $(this).on('click',updateDivForm )
                    $(".timeStart").datepicker('destroy');
                    $('.timeStart').removeClass("hasDatepicker").removeAttr('id');  
                    $(".timeStart").datepicker({
                        beforeShowDay: renderCalendarCallback
                    });

                    $(".timeEnd").datepicker('destroy');
                    $('.timeEnd').removeClass("hasDatepicker").removeAttr('id');  
                    $(".timeEnd").datepicker({
                        beforeShowDay: renderCalendarCallback
                    });
                }
            );
            e.preventDefault();
        });
    });
}